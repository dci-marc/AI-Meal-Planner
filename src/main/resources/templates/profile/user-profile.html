<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>User Profile</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: linear-gradient(135deg, #0F2027, #203A43, #2C5364);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 2rem 0;
    }

    .profile-card {
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(12px);
      padding: 2rem;
      border-radius: 18px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.35);
      width: 100%;
      max-width: 650px;
      color: #ffffff;
      border: 1px solid rgba(255,255,255,0.15);
    }

    .form-label {
      color: #E0E0E0;
      font-weight: 500;
    }

    .btn-save {
      background-color: #eb8914;
      color: #fff;
      border: none;
      font-weight: 500;
      padding: 0.5rem 2rem;
    }
    .btn-save:hover { background-color: #d77d13; }

    .btn-skip {
      background-color: transparent;
      border: 1px solid #B0BEC5;
      color: #B0BEC5;
      font-weight: 500;
      padding: 0.5rem 2rem;
    }
    .btn-skip:hover {
      background-color: rgba(255,255,255,0.1);
      border-color: #ffffff;
      color: #ffffff;
    }

    .delete-section {
      margin-top: 2rem;
      padding-top: 1.5rem;
      border-top: 1px solid rgba(255,255,255,0.1);
    }

    .is-invalid {
      border-color: #ff6b6b !important;
      background-color: rgba(255, 107, 107, 0.1) !important;
    }
    .is-valid { border-color: #51cf66 !important; }

    .invalid-feedback {
      display: none;
      color: #ff6b6b;
      font-size: 0.85rem;
      margin-top: 0.35rem;
    }
    .valid-feedback {
      display: none;
      color: #51cf66;
      font-size: 0.85rem;
      margin-top: 0.35rem;
    }

    .form-control,
    .form-select {
      background-color: #1a2530 !important;
      color: #ffffff !important;
      border: 1px solid rgba(255, 255, 255, 0.15) !important;
    }

    .form-control:focus,
    .form-select:focus {
      background-color: #1a2530 !important;
      color: #ffffff !important;
      border-color: #eb8914 !important;
      box-shadow: 0 0 0 0.25rem rgba(235, 137, 20, 0.25) !important;
    }

    .form-control::placeholder {
      color: rgba(255, 255, 255, 0.6) !important;
    }

    .form-select option,
    .form-select optgroup {
      background-color: #0f1b26 !important;
      color: #e6edf3 !important;
    }

    .form-select option:checked,
    .form-select option:hover,
    .form-select:focus option:checked {
      background-color: #263445 !important;
      color: #ffffff !important;
    }

    .form-control:disabled,
    .form-select:disabled {
      background-color: #16202a !important;
      color: rgba(255, 255, 255, 0.6) !important;
      opacity: 1 !important;
    }

    input.form-control:-webkit-autofill {
      -webkit-text-fill-color: #ffffff !important;
      -webkit-box-shadow: 0 0 0px 1000px #1a2530 inset !important;
      box-shadow: 0 0 0px 1000px #1a2530 inset !important;
    }

    .form-text { color: rgba(255, 255, 255, 0.7) !important; }

    .progress-container { margin-bottom: 1.5rem; }
    .progress {
      height: 8px;
      background-color: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
    }
    .progress-bar {
      background-color: #eb8914;
      transition: width 0.5s ease;
    }

    .section-title {
      border-left: 4px solid #eb8914;
      padding-left: 0.75rem;
      margin: 1.5rem 0 1rem 0;
    }
  </style>
</head>
<body>
<div class="profile-card">
  <h3 class="fw-bold text-center mb-4">Complete Your Profile</h3>

  <!-- Profile Completion Progress Bar -->
  <div class="progress-container">
    <div class="d-flex justify-content-between">
      <span>Profile Completion</span>
      <span id="completion-percentage">0%</span>
    </div>
    <div class="progress">
      <div class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
    </div>
  </div>

  <!-- Save Profile Form -->
  <form method="post" th:action="@{/profile}" id="profileForm" novalidate th:object="${userInformation}">
    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

    <h5 class="section-title">Personal Information</h5>
    <div class="row mb-3">
      <div class="col">
        <label class="form-label" for="firstName">First Name *</label>
        <input type="text" class="form-control" id="firstName" th:field="*{firstName}" required>
        <div class="invalid-feedback">Please provide your first name.</div>
      </div>
      <div class="col">
        <label class="form-label" for="lastName">Last Name *</label>
        <input type="text" class="form-control" id="lastName" th:field="*{lastName}" required>
        <div class="invalid-feedback">Please provide your last name.</div>
      </div>
    </div>

    <div class="row mb-3">
      <div class="col">
        <label class="form-label" for="age">Age *</label>
        <input type="number" class="form-control" id="age" th:field="*{age}" min="13" max="120" required>
        <div class="invalid-feedback">Please provide a valid age (13-120).</div>
      </div>
      <div class="col">
        <label class="form-label" for="birthDate">Birth Date *</label>
        <input type="date" class="form-control" id="birthDate" th:field="*{birthDate}" required>
        <div class="invalid-feedback">Please provide your birth date.</div>
      </div>
    </div>

    <div class="mb-3">
      <label class="form-label" for="gender">Gender *</label>
      <select class="form-select" id="gender" th:field="*{gender}" required>
        <option value="">-- Select --</option>
        <option th:each="gender : ${genderList}"
                th:value="${gender}"
                th:text="${#strings.toLowerCase(gender.name())}">
        </option>
      </select>
      <div class="invalid-feedback">Please select your gender.</div>
    </div>

    <h5 class="section-title">Physical Attributes</h5>
    <div class="row mb-3">
      <div class="col">
        <label class="form-label" for="heightCm">Height (cm) *</label>
        <input type="number" class="form-control" id="heightCm" th:field="*{heightCm}" min="100" max="250" required>
        <div class="invalid-feedback">Please provide a valid height (100-250 cm).</div>
      </div>
      <div class="col">
        <label class="form-label" for="weightKg">Weight (kg) *</label>
        <input type="number" step="0.1" class="form-control" id="weightKg" th:field="*{weightKg}" min="30" max="300" required>
        <div class="invalid-feedback">Please provide a valid weight (30-300 kg).</div>
      </div>
    </div>

    <h5 class="section-title">Activity & Goals</h5>
    <div class="mb-3">
      <label for="activityLevel" class="form-label">Activity Level *</label>
      <select class="form-select" th:field="*{activityLevel}" id="activityLevel" required>
        <option value="">-- Select --</option>
        <option th:each="level : ${activityLevels}"
                th:value="${level}"
                th:text="${level.description}">
        </option>
      </select>
      <div class="invalid-feedback">Please select your activity level.</div>
    </div>

    <div class="mb-3">
      <label class="form-label" for="goal">Goal *</label>
      <select class="form-select" id="goal" th:field="*{goal}" required>
        <option value="">-- Select --</option>
        <option th:each="goal : ${goals}"
                th:value="${goal}"
                th:text="${goal.name()}">
        </option>
      </select>
      <div class="invalid-feedback">Please select your goal.</div>
    </div>

    <div class="row mb-3">
      <div class="col">
        <label class="form-label" for="mealsPerDay">Meals Per Day *</label>
        <input type="number" class="form-control" id="mealsPerDay" th:field="*{mealsPerDay}" min="1" max="10" required>
        <div class="invalid-feedback">Please specify meals per day (1-10).</div>
      </div>
      <div class="col">
        <label class="form-label" for="targetKcalPerDay">Target Calories (kcal/day)</label>
        <input type="number" class="form-control" id="targetKcalPerDay" th:field="*{targetKcalPerDay}" min="800" max="5000">
        <div class="invalid-feedback">Please provide a valid calorie target (800-5000 kcal).</div>
        <div class="form-text">Leave blank to calculate automatically based on your profile</div>
      </div>
    </div>

    <div class="mb-3">
      <label class="form-label" for="dietaryPreferences">Dietary Preferences</label>
      <!-- Submit IDs to match service (dietaryPreferenceIds) -->
      <select class="form-select" id="dietaryPreferences" name="dietaryPreferenceIds" multiple size="4">
        <option th:each="pre : ${preferences}"
                th:value="${pre.id}"
                th:text="${pre.name}"
                th:selected="${userInformation.dietaryPreferences != null
                   and #lists.contains(userInformation.dietaryPreferences.![id], pre.id)}">
        </option>
      </select>
      <div class="form-text">Hold Ctrl (Windows) or Command (Mac) to select multiple.</div>
    </div>

    <div class="d-flex justify-content-between mt-4">
      <button type="submit" class="btn btn-save">Save Profile</button>
      <a th:href="@{/profile/skip}" class="btn btn-skip">Skip for Now</a>
    </div>
  </form>

  <!-- Delete Profile Form (if user already has a profile) -->
  <div th:if="${userInformation?.id != null}" class="delete-section">
    <h5 class="text-center mb-3">Danger Zone</h5>
    <form method="post" th:action="@{'/profile/' + ${userInformation.id}}" id="deleteForm">
      <input type="hidden" name="_method" value="delete">
      <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
      <div class="d-grid">
        <button type="submit" class="btn btn-outline-danger"
                onclick="return confirm('Are you sure you want to delete your profile? This action cannot be undone.')">
          Delete Profile
        </button>
      </div>
    </form>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('profileForm');
    const progressBar = document.querySelector('.progress-bar');
    const completionPercentage = document.getElementById('completion-percentage');

    function calculateCompletion() {
      const requiredFields = form.querySelectorAll('[required]');
      let completedCount = 0;
      requiredFields.forEach(field => {
        if (field.value.trim() !== '') completedCount++;
      });
      const percentage = Math.round((completedCount / requiredFields.length) * 100);
      progressBar.style.width = `${percentage}%`;
      progressBar.setAttribute('aria-valuenow', percentage);
      completionPercentage.textContent = `${percentage}%`;
      return percentage;
    }

    function validateField(field) {
      const value = field.value.trim();
      let isValid = true;

      field.classList.remove('is-invalid', 'is-valid');
      if (field.nextElementSibling && field.nextElementSibling.classList.contains('invalid-feedback')) {
        field.nextElementSibling.style.display = 'none';
      }

      if (field.hasAttribute('required') && !value) {
        showError(field, (field.nextElementSibling && field.nextElementSibling.textContent) || 'This field is required.');
        isValid = false;
      }

      if (value && isValid) {
        switch(field.type) {
          case 'number':
            const min = parseFloat(field.getAttribute('min')) || -Infinity;
            const max = parseFloat(field.getAttribute('max')) || Infinity;
            const numValue = parseFloat(value);
            if (isNaN(numValue) || numValue < min || numValue > max) {
              showError(field, `Please enter a value between ${min} and ${max}.`);
              isValid = false;
            }
            break;
          case 'date':
            const inputDate = new Date(value);
            const today = new Date();
            if (inputDate > today) {
              showError(field, 'Birth date cannot be in the future.');
              isValid = false;
            }
            break;
        }
      }

      if (isValid && value) field.classList.add('is-valid');
      calculateCompletion();
      return isValid;
    }

    function showError(field, message) {
      field.classList.add('is-invalid');
      const feedback = field.nextElementSibling;
      if (feedback && feedback.classList.contains('invalid-feedback')) {
        feedback.textContent = message;
        feedback.style.display = 'block';
      }
    }

    function validateForm() {
      const fields = form.querySelectorAll('input, select');
      let isValid = true;
      fields.forEach(field => { if (!validateField(field)) isValid = false; });
      return isValid;
    }

    const fields = form.querySelectorAll('input, select');
    fields.forEach(field => {
      field.addEventListener('blur', () => validateField(field));
      field.addEventListener('input', () => {
        field.classList.remove('is-invalid', 'is-valid');
        if (field.nextElementSibling && field.nextElementSibling.classList.contains('invalid-feedback')) {
          field.nextElementSibling.style.display = 'none';
        }
        calculateCompletion();
      });
    });

    form.addEventListener('submit', function(e) {
      e.preventDefault();
      if (validateForm()) this.submit();
      else {
        const firstError = this.querySelector('.is-invalid');
        if (firstError) {
          firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
          firstError.focus();
        }
      }
    });

    calculateCompletion();
    fields.forEach(field => { if (field.value) validateField(field); });
  });
</script>
</body>
</html>
