<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Your Profile â€¢ AI Meal Planner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/navigation_tab_styles.css">
  <style>
    body { background:#f7f7fb; }
    .wrap { max-width: 920px; }
    .card { border:1px solid rgba(0,0,0,.06); border-radius:18px; }
    .section-title { border-left:4px solid #eb8914; padding-left:.75rem; margin:1.5rem 0 1rem; }
  </style>
</head>
<body>
<div th:replace="~{fragments/navigation_tab :: navigation}"></div>

<main class="container wrap my-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h4 m-0">Your Profile</h1>
    <a href="/dashboard" class="btn btn-outline-secondary btn-sm">Back to Dashboard</a>
  </div>

  <div th:if="${param.saved}" class="alert alert-success">Profile saved.</div>

  <div class="card shadow-sm">
    <div class="card-body">
      <form method="post" th:action="@{/profile}" th:object="${userInformation}">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

        <h5 class="section-title">Account</h5>
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Email</label>
            <input type="email" class="form-control" th:value="${loggedInUser != null ? loggedInUser.email() : ''}" readonly>
          </div>
        </div>

        <h5 class="section-title">Personal Information</h5>
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label" for="firstName">First Name *</label>
            <input type="text" class="form-control" id="firstName" th:field="*{firstName}" required
                   th:classappend="${#fields.hasErrors('firstName')}? ' is-invalid'">
            <div class="invalid-feedback" th:if="${#fields.hasErrors('firstName')}" th:errors="*{firstName}"></div>
          </div>
          <div class="col-md-6">
            <label class="form-label" for="lastName">Last Name *</label>
            <input type="text" class="form-control" id="lastName" th:field="*{lastName}" required
                   th:classappend="${#fields.hasErrors('lastName')}? ' is-invalid'">
            <div class="invalid-feedback" th:if="${#fields.hasErrors('lastName')}" th:errors="*{lastName}"></div>
          </div>
          <div class="col-md-4">
            <label class="form-label" for="age">Age *</label>
            <input type="number" class="form-control" id="age" th:field="*{age}" min="13" max="120" required
                   th:classappend="${#fields.hasErrors('age')}? ' is-invalid'">
            <div class="invalid-feedback" th:if="${#fields.hasErrors('age')}" th:errors="*{age}"></div>
          </div>
          <div class="col-md-4">
            <label class="form-label" for="birthDate">Birth Date *</label>
            <input type="date" class="form-control" id="birthDate"
                   th:field="*{birthDate}"
                   th:attr="max=${todayIso}" required
                   th:classappend="${#fields.hasErrors('birthDate')}? ' is-invalid'">
            <div class="invalid-feedback" th:if="${#fields.hasErrors('birthDate')}" th:errors="*{birthDate}"></div>
          </div>
          <div class="col-md-4">
            <label class="form-label" for="gender">Gender *</label>
            <select class="form-select" id="gender" th:field="*{gender}" required
                    th:classappend="${#fields.hasErrors('gender')}? ' is-invalid'">
              <option value="">-- Select --</option>
              <option th:each="g : ${genderList}" th:value="${g}" th:text="${#strings.toLowerCase(g.name())}"></option>
            </select>
            <div class="invalid-feedback" th:if="${#fields.hasErrors('gender')}" th:errors="*{gender}"></div>
          </div>
        </div>

        <h5 class="section-title">Physical Attributes</h5>
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label" for="heightCm">Height (cm) *</label>
            <input type="number" class="form-control" id="heightCm" th:field="*{heightCm}" min="100" max="250" required
                   th:classappend="${#fields.hasErrors('heightCm')}? ' is-invalid'">
            <div class="invalid-feedback" th:if="${#fields.hasErrors('heightCm')}" th:errors="*{heightCm}"></div>
          </div>
          <div class="col-md-6">
            <label class="form-label" for="weightKg">Weight (kg) *</label>
            <input type="number" step="0.1" class="form-control" id="weightKg" th:field="*{weightKg}" min="30" max="300" required
                   th:classappend="${#fields.hasErrors('weightKg')}? ' is-invalid'">
            <div class="invalid-feedback" th:if="${#fields.hasErrors('weightKg')}" th:errors="*{weightKg}"></div>
          </div>
        </div>

        <h5 class="section-title">Activity & Goals</h5>
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label" for="activityLevel">Activity Level *</label>
            <select class="form-select" id="activityLevel" th:field="*{activityLevel}" required
                    th:classappend="${#fields.hasErrors('activityLevel')}? ' is-invalid'">
              <option value="">-- Select --</option>
              <option th:each="level : ${activityLevels}" th:value="${level}" th:text="${level.description}"></option>
            </select>
            <div class="invalid-feedback" th:if="${#fields.hasErrors('activityLevel')}" th:errors="*{activityLevel}"></div>
          </div>
          <div class="col-md-6">
            <label class="form-label" for="goal">Goal *</label>
            <select class="form-select" id="goal" th:field="*{goal}" required
                    th:classappend="${#fields.hasErrors('goal')}? ' is-invalid'">
              <option value="">-- Select --</option>
              <option th:each="goal : ${goals}" th:value="${goal}" th:text="${#strings.toLowerCase(goal.name())}"></option>
            </select>
            <div class="invalid-feedback" th:if="${#fields.hasErrors('goal')}" th:errors="*{goal}"></div>
          </div>
          <div class="col-md-6">
            <label class="form-label" for="mealsPerDay">Meals Per Day *</label>
            <input type="number" class="form-control" id="mealsPerDay" th:field="*{mealsPerDay}" min="1" max="10" required
                   th:classappend="${#fields.hasErrors('mealsPerDay')}? ' is-invalid'">
            <div class="invalid-feedback" th:if="${#fields.hasErrors('mealsPerDay')}" th:errors="*{mealsPerDay}"></div>
          </div>
          <div class="col-md-6">
            <label class="form-label" for="targetKcalPerDay">Target Calories (kcal/day)</label>
            <input type="number" class="form-control" id="targetKcalPerDay" th:field="*{targetKcalPerDay}" min="800" max="5000"
                   th:classappend="${#fields.hasErrors('targetKcalPerDay')}? ' is-invalid'">
            <div class="form-text">Leave blank to calculate automatically from your profile.</div>
            <div class="invalid-feedback" th:if="${#fields.hasErrors('targetKcalPerDay')}" th:errors="*{targetKcalPerDay}"></div>
          </div>
        </div>

        <h5 class="section-title">Dietary Preferences</h5>
        <div class="mb-3">
          <select class="form-select" id="dietaryPreferences" name="dietaryPreferenceIds" multiple size="6"
                  th:classappend="${#fields.hasErrors('dietaryPreferences')}? ' is-invalid'">
            <option th:each="pre : ${preferences}"
                    th:value="${pre.id}"
                    th:text="${pre.name}"
                    th:selected="${userInformation.dietaryPreferences != null
                       and #lists.contains(userInformation.dietaryPreferences.![id], pre.id)}">
            </option>
          </select>
          <div class="form-text">Hold Ctrl/Command to select multiple.</div>
          <div class="invalid-feedback" th:if="${#fields.hasErrors('dietaryPreferences')}" th:errors="*{dietaryPreferences}"></div>
        </div>

        <div class="d-flex gap-2 justify-content-end mt-3">
          <a href="/dashboard" class="btn btn-outline-secondary">Cancel</a>
          <button type="submit" class="btn" style="background:#eb8914;color:#fff;">Save</button>
        </div>
      </form>
    </div>
  </div>
</main>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    var birth = document.getElementById('birthDate');
    var max = birth ? birth.getAttribute('max') : null;
    if (birth && max && birth.value && birth.value > max) birth.value = max;
  });
</script>
</body>
</html>
