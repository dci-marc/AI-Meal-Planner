<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title th:text="${mealPlan.name}">Meal Plan</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"/>
    <style>
        .slot-badge { min-width: 90px; display: inline-block; }
        .entry-card { border:1px solid #e9ecef; border-radius:.5rem; padding:.5rem .75rem; }
    </style>
</head>
<body class="container py-4">

<div th:if="${success}" class="alert alert-success" th:text="${success}"></div>
<div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>

<div class="d-flex justify-content-between align-items-center">
    <div>
        <h2 class="mb-1" th:text="${mealPlan.name}">Plan name</h2>
        <div class="text-muted">
            <span th:text="${#temporals.format(mealPlan.startDate, 'dd MMM yyyy')}">Start</span>
            —
            <span th:text="${#temporals.format(mealPlan.endDate, 'dd MMM yyyy')}">End</span>
            <span th:if="${mealPlan.kcalTargetPerDay != null}">
          · Target: <strong th:text="${mealPlan.kcalTargetPerDay}">0</strong> kcal/day
        </span>
        </div>
    </div>
    <div class="d-flex gap-2">
        <form th:action="@{|/meal-plans/${mealPlan.id}/ai-populate|}" method="post" class="d-inline">
            <button class="btn btn-primary">Generate with AI</button>
        </form>
        <a class="btn btn-outline-secondary" th:href="@{/meal-plans}">Back</a>
    </div>
</div>

<hr/>

<div class="card mb-4">
    <div class="card-body">
        <form th:action="@{|/meal-plans/${mealPlan.id}/entries|}" th:object="${addEntry}" method="post" class="row g-3 align-items-end">
            <input type="hidden" th:field="*{mealPlanId}" th:value="${mealPlan.id}"/>

            <div class="col-md-3">
                <label class="form-label">Date</label>
                <input type="date" class="form-control" th:field="*{entryDate}"/>
            </div>

            <div class="col-md-3">
                <label class="form-label">Meal slot</label>
                <select class="form-select" th:field="*{mealSlot}">
                    <option th:each="s : ${mealSlots}" th:value="${s}" th:text="${s}">BREAKFAST</option>
                </select>
            </div>

            <div class="col-md-4">
                <label class="form-label">Recipe ID</label>
                <input type="number" class="form-control" th:field="*{recipeId}" placeholder="Enter Recipe ID"/>
            </div>

            <div class="col-md-2">
                <label class="form-label">Servings</label>
                <input type="number" step="0.5" min="0.5" class="form-control" th:field="*{servings}"/>
            </div>

            <div class="col-12">
                <button class="btn btn-success">Add entry</button>
            </div>
        </form>
    </div>
</div>

<div th:each="entry : ${entriesByDate.entrySet()}">
    <h5 class="mt-4"
        th:with="k=${entry.key},
                 dObj=${k instanceof T(java.time.temporal.TemporalAccessor) ? k : #temporals.parseISO(k)}">
        <span th:text="${#temporals.format(dObj, 'EEEE, dd MMM yyyy')}">Date</span>
    </h5>

    <div class="row g-3">
        <div class="col-12" th:each="meal : ${entry.value}">
            <div class="entry-card d-flex justify-content-between align-items-center">
                <div>
                    <span class="badge text-bg-light slot-badge" th:text="${meal.mealSlot}">LUNCH</span>
                    <a th:href="@{|/recipes/${meal.recipe.id}|}" th:text="${meal.recipe.title}" class="ms-2">Recipe title</a>
                    <span class="text-muted ms-2" th:if="${meal.servings != null}">
              · <span th:text="${meal.servings}">1</span> serving(s)
            </span>
                </div>
                <form th:action="@{|/meal-plans/entries/${meal.id}/delete|}" method="post" class="ms-3">
                    <input type="hidden" name="planId" th:value="${mealPlan.id}"/>
                    <button class="btn btn-sm btn-outline-danger" onclick="return confirm('Remove this entry?')">Remove</button>
                </form>
            </div>
        </div>
    </div>
</div>

</body>
</html>
