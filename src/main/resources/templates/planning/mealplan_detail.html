<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title th:text="${mealPlan.name}">Meal Plan</title>
    <link rel="stylesheet" href="/css/navigation_tab_styles.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"/>
    <style>
        body { background:#f7f7fb; }
        .hero {
            background: linear-gradient(180deg,#ffffff,#f7f7fb);
            border-bottom: 1px solid rgba(0,0,0,.06);
            padding: 1.25rem 0 1rem;
        }
        .plan-title { font-weight:700; letter-spacing:.2px; font-size:clamp(1.5rem,3vw,2.1rem); }
        .meta-item { display:inline-flex; align-items:center; gap:.5rem; }
        .meta-badge { font-weight:600; }
        .slot-badge { min-width:90px; display:inline-block; }
        .entry-card { border:1px solid #e9ecef; border-radius:.75rem; padding:.6rem .85rem; background:#fff; }
        .section-card { background:#fff; border:1px solid rgba(0,0,0,.06); border-radius:.75rem; }
        .section-card .card-header { background:transparent; border-bottom:1px solid rgba(0,0,0,.06); font-weight:700; }
        .with-nav-offset { padding-top:.75rem; }

        .typeahead-wrap { position: relative; }
        .typeahead-results {
            position:absolute; top:100%; left:0; right:0; z-index: 1050;
            background:#fff; border:1px solid rgba(0,0,0,.175); border-radius:.375rem;
            max-height: 260px; overflow:auto; display:none;
        }
        .typeahead-results .list-group-item { cursor: pointer; }
        .selected-pill {
            display:inline-flex; align-items:center; gap:.5rem;
            background:#eef5ff; color:#0d6efd; border:1px solid #d7e6ff;
            border-radius:999px; padding:.25rem .5rem; font-weight:600;
        }
        .selected-pill button {
            border:0; background:transparent; line-height:1; font-size:1rem; color:#0d6efd;
        }
    </style>
</head>
<body class="bg-light">
<div th:replace="~{/fragments/navigation_tab :: navigation}"></div>

<header class="hero">
    <div class="container">
        <div class="d-flex flex-column flex-lg-row align-items-lg-end gap-3 flex-lg-nowrap">
            <div class="flex-grow-1 min-w-0">
                <h1 class="plan-title mb-1 text-truncate" th:text="${mealPlan.name}">Plan name</h1>
                <div class="d-flex flex-wrap gap-3 text-muted">
                    <span class="meta-item">
                        <span class="badge text-bg-light meta-badge">Dates</span>
                        <span>
                            <span th:text="${#temporals.format(mealPlan.startDate, 'dd MMM yyyy')}">Start</span>
                            — <span th:text="${#temporals.format(mealPlan.endDate, 'dd MMM yyyy')}">End</span>
                        </span>
                    </span>
                    <span class="meta-item" th:if="${mealPlan.kcalTargetPerDay != null}">
                        <span class="badge text-bg-light meta-badge">Target</span>
                        <span><strong th:text="${mealPlan.kcalTargetPerDay}">0</strong> kcal/day</span>
                    </span>
                </div>
            </div>

            <div class="btn-toolbar gap-2 ms-lg-auto flex-lg-nowrap">
                <a class="btn btn-outline-secondary btn-sm" th:href="@{/meal-plans}">Back to Plans</a>
            </div>
        </div>
    </div>
</header>

<main class="container with-nav-offset py-4">
    <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>
    <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>

    <div class="section-card mb-4">
        <div class="card-header">Add to this plan</div>
        <div class="card-body">
            <form th:action="@{|/meal-plans/${mealPlan.id}/entries|}"
                  th:object="${addEntry}"
                  method="post"
                  class="row g-3 align-items-start">

                <input type="hidden" th:field="*{mealPlanId}" th:value="${mealPlan.id}"/>
                <input type="hidden" th:field="*{recipeId}" id="selectedRecipeId"/>

                <div class="col-12 col-lg-2">
                    <label class="form-label">Date</label>
                    <input type="date" class="form-control" th:field="*{entryDate}"/>
                </div>

                <div class="col-12 col-lg-2">
                    <label class="form-label">Meal slot</label>
                    <select class="form-select" th:field="*{mealSlot}">
                        <option th:each="s : ${mealSlots}" th:value="${s}" th:text="${#strings.toLowerCase(s)}">breakfast</option>
                    </select>
                </div>

                <div class="col-12 col-lg-5">
                    <label class="form-label">Recipe</label>
                    <div class="typeahead-wrap">
                        <input id="recipeSearch" type="text" class="form-control" placeholder="Type to search your recipes…" autocomplete="off">
                        <div id="recipeResults" class="typeahead-results list-group"></div>
                    </div>
                    <div id="chosenRecipe" class="mt-2" style="display:none;"></div>
                </div>

                <div class="col-6 col-lg-2">
                    <label class="form-label">Servings</label>
                    <input type="number" step="0.5" min="0.5" class="form-control" th:field="*{servings}"/>
                </div>

                <div class="col-6 col-lg-1 d-grid align-self-start">
                    <button class="btn btn-success">Add entry</button>
                </div>

                <div class="col-12">
                    <small class="text-muted">
                        Note: If the selected date already has this meal slot, it will be <strong>replaced</strong>.
                    </small>
                </div>
            </form>
        </div>
    </div>

    <div th:if="${#maps.isEmpty(entriesByDate)}" class="alert alert-info d-flex align-items-center justify-content-between">
        <div>
            This plan has no entries yet. Use <strong>Add to this plan</strong> above
            or let AI generate a starter plan.
        </div>
        <form th:action="@{|/meal-plans/${mealPlan.id}/ai-populate|}" method="post" class="ms-3">
            <button class="btn btn-sm btn-primary">Populate with AI</button>
        </form>
    </div>


    <div th:each="entry : ${entriesByDate.entrySet()}">
        <h5 class="mt-4"
            th:with="k=${entry.key},
                     dObj=${k instanceof T(java.time.temporal.TemporalAccessor) ? k : #temporals.parseISO(k)}">
            <span th:text="${#temporals.format(dObj, 'EEEE, dd MMM yyyy')}">Date</span>
        </h5>

        <div class="row g-3">
            <div class="col-12" th:each="meal : ${entry.value}">
                <div class="entry-card d-flex justify-content-between align-items-center">
                    <div class="text-truncate">
                        <span class="badge text-bg-light slot-badge" th:text="${#strings.toLowerCase(meal.mealSlot)}">lunch</span>
                        <a class="ms-2 text-decoration-none"
                           th:href="@{|/recipes/${meal.recipe.id}|}"
                           th:text="${meal.recipe.title}">Recipe title</a>
                        <span class="text-muted ms-2" th:if="${meal.servings != null}">
                          · <span th:text="${meal.servings.stripTrailingZeros().toPlainString()}">1</span> serving(s)
                        </span>
                    </div>
                    <form th:action="@{|/meal-plans/entries/${meal.id}/delete|}" method="post" class="ms-3">
                        <input type="hidden" name="planId" th:value="${mealPlan.id}"/>
                        <button class="btn btn-sm btn-outline-danger" onclick="return confirm('Remove this entry?')">Remove</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</main>

<script>
    (function () {
        const API_URL = '/api/recipes/planner-search';
        const input  = document.getElementById('recipeSearch');
        const list   = document.getElementById('recipeResults');
        const chosen = document.getElementById('chosenRecipe');
        const hiddenId = document.getElementById('selectedRecipeId');
        let timer, abortCtrl;

        function showList(show) { list.style.display = show ? 'block' : 'none'; }

        function clearChoice() {
            hiddenId.value = '';
            chosen.innerHTML = '';
            chosen.style.display = 'none';
            input.value = '';
            input.focus();
        }

        function setChoice(item) {
            hiddenId.value = item.id;
            chosen.innerHTML = `
              <span class="selected-pill">
                <span>${item.title}</span>
                <button type="button" aria-label="Remove" title="Remove">&times;</button>
              </span>`;
            chosen.querySelector('button').onclick = clearChoice;
            chosen.style.display = 'block';
            input.value = '';
            showList(false);
        }

        function render(listData) {
            list.innerHTML = '';
            if (!listData || listData.length === 0) {
                const empty = document.createElement('div');
                empty.className = 'list-group-item text-muted';
                empty.textContent = 'No results';
                list.appendChild(empty);
                showList(true);
                return;
            }
            listData.forEach(it => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'list-group-item list-group-item-action';
                btn.textContent = it.title;
                btn.onclick = () => setChoice(it);
                list.appendChild(btn);
            });
            showList(true);
        }

        async function search(q) {
            if (!q || q.trim().length < 2) { showList(false); return; }
            if (abortCtrl) abortCtrl.abort();
            abortCtrl = new AbortController();
            try {
                const r = await fetch(`${API_URL}?q=${encodeURIComponent(q)}&size=20`, { signal: abortCtrl.signal });
                if (!r.ok) { showList(false); return; }
                const data = await r.json();
                const content = Array.isArray(data) ? data : (Array.isArray(data.content) ? data.content : []);
                render(content.map(x => ({ id: x.id, title: x.title })));
            } catch(e) {
                if (e.name !== 'AbortError') showList(false);
            }
        }

        input?.addEventListener('input', () => {
            clearTimeout(timer);
            timer = setTimeout(() => search(input.value), 200);
        });
        input?.addEventListener('focus', () => {
            const q = input.value.trim();
            if (q.length >= 2) search(q);
        });
        input?.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && list.firstChild && list.style.display === 'block') {
                e.preventDefault();
                list.firstChild.click();
            }
        });
        document.addEventListener('click', (e) => {
            if (!list.contains(e.target) && e.target !== input) showList(false);
        });
    })();
</script>
</body>
</html>
