<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <title th:text="${recipe.id == null ? 'Add Recipe' : 'Edit Recipe'}">Recipe</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/css/navigation_tab_styles.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    :root{
      --accent:#0d6efd;
      --muted:#6c757d;
      --soft-bg:#f8f9fa;
      --card-bg:#ffffff;
      --ring:rgba(13,110,253,.25);
      --table-head:#f2f4f7;
    }
    body.bg-light{background:linear-gradient(180deg,#f7f9fc 0%,#f1f3f5 100%);}
    .card{border-radius:.75rem;border:1px solid #e5e7eb;background:var(--card-bg);}
    .form-label{font-weight:500;color:#212529;}
    .form-control,.form-select{border-radius:.5rem;transition:border .2s,box-shadow .2s;}
    .form-control:focus,.form-select:focus{border-color:var(--accent);box-shadow:0 0 0 .25rem var(--ring);}
    .btn{border-radius:.5rem;padding:.5rem 1rem;font-weight:500;}
    .btn-primary{background:var(--accent);border-color:var(--accent);}
    .btn-outline-danger{border-radius:.375rem;}
    .table thead{background:var(--table-head);}
    .table th{font-weight:600;color:#495057;}
    textarea.form-control{resize:vertical;}
    #ta-results-global{position:fixed;z-index:5000;display:none;max-height:240px;overflow:auto;background:#fff;border:1px solid rgba(0,0,0,.175);border-radius:.375rem;box-shadow:0 8px 24px rgba(0,0,0,.12);}
    #ta-results-global .list-group-item{padding:.5rem .75rem;cursor:pointer;}
    #ta-results-global .list-group-item:hover{background-color:var(--soft-bg);}

    .cat-dropdown .dropdown-menu{
      width:min(600px, 100%);
      max-height:320px; overflow:auto;
      padding:.5rem;
    }
    .cat-dropdown .list-group-item{
      border:0; padding:.25rem .25rem;
    }
    .hint{color:var(--muted); font-size:.875rem;}
  </style>
</head>
<body class="bg-light">
<div th:replace="~{/fragments/navigation_tab :: navigation}"></div>
<div class="container py-4">
  <h2 class="mb-4" th:text="${recipe.id == null ? 'Add Recipe' : 'Edit Recipe'}"></h2>

  <form th:object="${recipe}"
        th:action="${recipe.id == null} ? @{/recipes/create} : @{/recipes/update/{id}(id=${recipe.id})}"
        method="post" enctype="multipart/form-data"
        class="card shadow-sm p-4">

    <input type="hidden" name="redirectUrl" th:value="${redirectUrl}" />

    <div class="row g-3">
      <div class="col-md-8">
        <label class="form-label">Title</label>
        <input th:field="*{title}" class="form-control" placeholder="e.g., Creamy Tomato Pasta" />
        <div class="text-danger" th:if="${#fields.hasErrors('title')}" th:errors="*{title}"></div>
      </div>

      <div class="col-md-4">
        <label for="difficulty" class="form-label">Difficulty</label>
        <select id="difficulty" th:field="*{difficulty}" class="form-select" required>
          <option value="" th:if="${recipe.id == null}" selected>Select Difficulty</option>
          <option th:each="difficulty : ${difficulties}"
                  th:value="${difficulty}"
                  th:text="${#strings.toLowerCase(difficulty.name())}"
                  th:selected="${recipe.difficulty != null && difficulty.name() == recipe.difficulty.name()}">
          </option>
        </select>
        <div class="text-danger" th:if="${#fields.hasErrors('difficulty')}" th:errors="*{difficulty}"></div>
      </div>

      <div class="col-md-4">
        <label class="form-label">Preparation Time (minutes)</label>
        <input type="number" th:field="*{preparationTimeMinutes}" class="form-control" min="1">
        <div class="text-danger" th:if="${#fields.hasErrors('preparationTimeMinutes')}" th:errors="*{preparationTimeMinutes}"></div>
      </div>

      <div class="col-md-4">
        <label class="form-label">Servings</label>
        <input type="number" min="0.01" step="0.01" th:field="*{servings}" class="form-control" />
      </div>

      <div class="col-md-4">
        <label class="form-label">Meal Categories</label>

        <select id="mealCategoriesHidden" th:field="*{mealCategories}" class="d-none" multiple>
          <option th:each="category : ${categories}"
                  th:value="${category.id}"
                  th:text="${category.name}"
                  th:selected="${recipe.mealCategories != null
                     and #lists.contains(recipe.mealCategories.![id], category.id)}">
          </option>
        </select>

        <div class="dropdown w-100 cat-dropdown">
          <button class="btn btn-outline-secondary w-100 d-flex justify-content-between align-items-center"
                  type="button" data-bs-toggle="dropdown" aria-expanded="false" id="catDropdownBtn">
            <span id="catDropdownLabel">Select categories…</span>
            <span class="badge text-bg-light ms-2" id="catCountBadge" style="display:none"></span>
          </button>
          <div class="dropdown-menu">
            <input id="catFilter" type="text" class="form-control mb-2" placeholder="Filter categories…" autocomplete="off">
            <div id="catList" class="list-group">
              <label class="list-group-item" th:each="category : ${categories}" th:attr="data-id=${category.id}">
                <input class="form-check-input me-2" type="checkbox"
                       th:attr="data-id=${category.id}"
                >
                <span th:text="${category.name}">Category</span>
              </label>
            </div>
          </div>
        </div>
        <div class="hint mt-1">Tip: Click to open, type to filter, tick the boxes. Press Esc to close.</div>
      </div>

      <div class="col-12">
        <div class="d-flex flex-column">
          <div class="d-flex align-items-center justify-content-between">
            <label class="form-label mb-0">Ingredients</label>
          </div>

          <div class="mt-1">
            <button type="button" class="btn btn-sm btn-secondary" onclick="addRow()">
              + Add ingredient row
            </button>
          </div>
        </div>

        <div class="table-responsive mt-2">
          <table class="table align-middle mb-0">
            <thead>
            <tr>
              <th style="width:45%">Ingredient</th>
              <th style="width:20%">Amount</th>
              <th style="width:25%">Unit</th>
              <th style="width:10%">Remove</th>
            </tr>
            </thead>
            <tbody id="ingredient-rows">
            <tr th:each="ri, iStat : *{ingredients}">
              <input type="hidden" th:field="*{ingredients[__${iStat.index}__].id}" />
              <td>
                <input type="hidden" th:field="*{ingredients[__${iStat.index}__].ingredient.id}">
                <input class="form-control ingredient-search"
                       th:value="${ri.ingredient != null ? ri.ingredient.name : ''}"
                       th:attr="data-initial-ingredient=${ri.ingredient != null ? ri.ingredient.id : ''}"
                       placeholder="Type to search…" autocomplete="off" autocapitalize="off" spellcheck="false">
              </td>
              <td>
                <input type="number" min="0.001" step="0.001" class="form-control"
                       th:field="*{ingredients[__${iStat.index}__].amount}">
              </td>
              <td>
                <select class="form-select unit-select"
                        th:field="*{ingredients[__${iStat.index}__].unit.id}"
                        th:attr="data-initial-unit=${ri.unit != null ? ri.unit.id : ''}">
                  <option value="">— none —</option>
                </select>
              </td>
              <td class="text-center">
                <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeRow(this)">✕</button>
              </td>
            </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="col-12">
        <label class="form-label">Instructions</label>
        <textarea th:field="*{instructions}" class="form-control" rows="6"
                  placeholder="Step 1…&#10;Step 2…"></textarea>
      </div>

      <div class="col-12">
        <label for="image" class="form-label">Upload Image</label>
        <input id="image" type="file" name="imageFile" class="form-control">
      </div>

      <div class="col-12 d-flex gap-2 mt-2">
        <button class="btn btn-primary" type="submit" th:text="${recipe.id == null ? 'Create' : 'Update'}"></button>
        <a th:href="${redirectUrl}" class="btn btn-secondary">Cancel</a>
        <button type="button" id="clearDraftBtn" class="btn btn-outline-secondary ms-auto">Clear draft</button>
      </div>
    </div>
  </form>
</div>

<div id="ta-results-global" class="list-group"></div>

<script th:inline="javascript">
  const API_ING = /*[[@{/api/ingredients}]]*/ '/api/ingredients';
  const API_UNITS_BASE = /*[[@{/api/ingredients/0/units}]]*/ '/api/ingredients/0/units';
  const NEW_ING_AI = /*[[@{/ingredients/new-ai}]]*/ '/ingredients/new-ai';

  function unitsUrlFor(ingId){ return API_UNITS_BASE.replace('/0/','/'+ingId+'/'); }

  function aiUrlFor(name){
    try { sessionStorage.setItem('recipe:allowRestoreOnce', '1'); } catch(_){}
    const ret = window.location.pathname + window.location.search + window.location.hash;
    return `${NEW_ING_AI}?name=${encodeURIComponent(name)}&return=${encodeURIComponent(ret)}`;
  }

  function nextIndex(){ return document.querySelectorAll('#ingredient-rows tr').length; }
  async function fetchJson(url){
    const r = await fetch(url, { headers: { 'Accept':'application/json' }});
    if(!r.ok) throw new Error(r.status+' '+r.statusText);
    return r.json();
  }

  async function loadUnits(selectEl, ingredientId, initialUnitId){
    selectEl.innerHTML = '<option value="">— none —</option>';
    if(!ingredientId) return;
    try{
      const units = await fetchJson(unitsUrlFor(ingredientId));
      units.forEach(u=>{
        const opt=document.createElement('option');
        opt.value = u.id; opt.textContent = u.label; selectEl.appendChild(opt);
      });
      if(initialUnitId){
        selectEl.value = String(initialUnitId);
        if(selectEl.value !== String(initialUnitId)) selectEl.value = '';
      }
    }catch(e){ console.error('Units fetch failed:', e); }
  }

  const panel = document.getElementById('ta-results-global');
  let activeInput=null, activeHidden=null, activeUnitSelect=null, debounceTimer=null, abortCtrl=null;

  function openPanelFor(input){
    const rect = input.getBoundingClientRect();
    panel.style.left = rect.left + 'px';
    panel.style.top  = (rect.bottom + window.scrollY) + 'px';
    panel.style.width= rect.width + 'px';
    panel.style.display = 'block';
  }
  function closePanel(){ panel.style.display='none'; panel.innerHTML=''; }

  async function searchIngredients(q){
    if(q.length < 1){ closePanel(); return; }
    if(abortCtrl) abortCtrl.abort();
    abortCtrl = new AbortController();
    try{
      const r = await fetch(`${API_ING}?q=${encodeURIComponent(q)}&size=50`, { signal: abortCtrl.signal });
      if(!r.ok){ console.error('Ingredient search failed:', r.status, r.statusText); closePanel(); return; }
      const page = await r.json();
      const list = page && page.content ? page.content : [];
      panel.innerHTML = '';
      if(list.length === 0){
        const empty = document.createElement('div');
        empty.className='list-group-item text-muted';
        empty.textContent='No results';
        panel.appendChild(empty);

        const add = document.createElement('button');
        add.type='button';
        add.className='list-group-item list-group-item-action';
        add.style.fontWeight='600';
        add.textContent = `Add "${q}" via AI`;
        add.dataset.aiAdd='true';
        add.addEventListener('pointerdown', (e)=>{
          e.preventDefault();
          try{ sessionStorage.setItem('recipe:lastIngredientQuery', q); }catch(_){}
          window.location.href = aiUrlFor(q);
        });
        panel.appendChild(add);
      }else{
        list.forEach(it=>{
          const btn=document.createElement('button');
          btn.type='button';
          btn.className='list-group-item list-group-item-action';
          btn.textContent=it.name;
          btn.addEventListener('pointerdown', async (e)=>{
            e.preventDefault();
            if(!activeInput || !activeHidden) return;
            activeHidden.value = it.id;
            activeInput.value  = it.name;
            closePanel();
            if(activeUnitSelect) await loadUnits(activeUnitSelect, it.id, null);
            activeInput.focus();
          });
          panel.appendChild(btn);
        });

        const footer = document.createElement('button');
        footer.type='button';
        footer.className='list-group-item list-group-item-action';
        footer.textContent = `Can’t find it? Add "${q}" via AI`;
        footer.addEventListener('pointerdown', (e)=>{
          e.preventDefault();
          try{ sessionStorage.setItem('recipe:lastIngredientQuery', q); }catch(_){}
          window.location.href = aiUrlFor(q);
        });
        panel.appendChild(footer);
      }
      if(activeInput) openPanelFor(activeInput);
    }catch(e){
      if(e.name !== 'AbortError') console.error('Ingredient search error:', e);
      closePanel();
    }
  }

  function wireRow(tr){
    const input    = tr.querySelector('.ingredient-search');
    const hiddenId = tr.querySelector('input[type="hidden"][name$=".ingredient.id"]');
    const unitSel  = tr.querySelector('.unit-select');

    const initIng  = input.getAttribute('data-initial-ingredient') || '';
    const initUnit = unitSel.getAttribute('data-initial-unit') || '';
    if(initIng) loadUnits(unitSel, initIng, initUnit);

    input.addEventListener('focus', ()=>{
      activeInput=input; activeHidden=hiddenId; activeUnitSelect=unitSel;
      if(input.value.trim().length >= 1){
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(()=>searchIngredients(input.value.trim()), 120);
      }
    });
    input.addEventListener('input', ()=>{
      activeInput=input; activeHidden=hiddenId; activeUnitSelect=unitSel;
      clearTimeout(debounceTimer);
      const q = input.value.trim();
      debounceTimer = setTimeout(()=>searchIngredients(q), 120);
    });
  }

  function addRow(){
    const i = nextIndex();
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <input type="hidden" name="ingredients[${i}].id" value="">
      <td>
        <input type="hidden" name="ingredients[${i}].ingredient.id" value="">
        <input class="form-control ingredient-search" placeholder="Type to search…" autocomplete="off" autocapitalize="off" spellcheck="false" data-initial-ingredient="">
      </td>
      <td>
        <input type="number" min="0.001" step="0.001" class="form-control"
               name="ingredients[${i}].amount" placeholder="e.g., 2.5">
      </td>
      <td>
        <select class="form-select unit-select" name="ingredients[${i}].unit.id" data-initial-unit="">
          <option value="">— none —</option>
        </select>
      </td>
      <td class="text-center">
        <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeRow(this)">✕</button>
      </td>
    `;
    document.getElementById('ingredient-rows').appendChild(tr);
    wireRow(tr);
  }

  function removeRow(btn){
    const tr = btn.closest('tr'); if(tr) tr.remove();
    document.querySelectorAll('#ingredient-rows tr').forEach((row, idx)=>{
      row.querySelectorAll('select, input').forEach(el=>{
        el.name = el.name.replace(/ingredients\[\d+]/, 'ingredients['+idx+']');
      });
    });
    closePanel();
  }

  document.addEventListener('keydown', (e)=>{
    const isIngInput = document.activeElement && document.activeElement.classList.contains('ingredient-search');
    if(!isIngInput) return;

    if(e.key === 'Enter'){
      e.preventDefault();
      if(panel.style.display === 'block'){
        const aiBtn = panel.querySelector('[data-ai-add="true"]');
        if(aiBtn){
          try{ sessionStorage.setItem('recipe:lastIngredientQuery', document.activeElement.value.trim()); }catch(_){}
          aiBtn.click();
          return;
        }
      }
    }
  });

  document.addEventListener('click', (e)=>{ if(panel.style.display==='block' && !panel.contains(e.target) && e.target !== activeInput) closePanel(); });
  window.addEventListener('scroll', ()=>{ if(panel.style.display==='block' && activeInput) openPanelFor(activeInput); }, true);
  window.addEventListener('resize', ()=>{ if(panel.style.display==='block' && activeInput) openPanelFor(activeInput); });

  function updateCatLabel(){
    const hidden = document.getElementById('mealCategoriesHidden');
    const selected = Array.from(hidden.selectedOptions).map(o=>o.textContent.trim());
    const label = document.getElementById('catDropdownLabel');
    const badge = document.getElementById('catCountBadge');
    if(selected.length === 0){
      label.textContent = 'Select categories…';
      badge.style.display = 'none';
    }else{
      label.textContent = selected.slice(0,3).join(', ') + (selected.length>3 ? ' …' : '');
      badge.textContent = selected.length;
      badge.style.display = '';
    }
  }
  function syncCheckboxesFromHidden(){
    const hidden = document.getElementById('mealCategoriesHidden');
    const set = new Set(Array.from(hidden.selectedOptions).map(o=>String(o.value)));
    document.querySelectorAll('#catList input[type="checkbox"]').forEach(cb=>{
      cb.checked = set.has(String(cb.dataset.id));
    });
    updateCatLabel();
  }
  function syncHiddenFromCheckboxes(){
    const hidden = document.getElementById('mealCategoriesHidden');
    const values = Array.from(document.querySelectorAll('#catList input[type="checkbox"]:checked')).map(cb=>String(cb.dataset.id));
    Array.from(hidden.options).forEach(opt => opt.selected = values.includes(String(opt.value)));
    updateCatLabel();
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    syncCheckboxesFromHidden();


    document.getElementById('catList').addEventListener('change', (e)=>{
      if(e.target.matches('input[type="checkbox"]')) syncHiddenFromCheckboxes();
    });


    const filter = document.getElementById('catFilter');
    filter.addEventListener('input', ()=>{
      const q = filter.value.trim().toLowerCase();
      document.querySelectorAll('#catList .list-group-item').forEach(li=>{
        const txt = li.textContent.trim().toLowerCase();
        li.style.display = txt.includes(q) ? '' : 'none';
      });
    });
  });


  const DRAFT_KEY = 'recipe:draft:' + location.pathname;
  const DRAFT_TTL_MIN = 45;
  let __suppressNextSave = false;

  function readDraft(){
    const raw = sessionStorage.getItem(DRAFT_KEY);
    if(!raw) return null;
    try{
      const parsed = JSON.parse(raw);
      if(!parsed || typeof parsed !== 'object') return null;
      const ts = parsed.__ts || 0;
      const ageMin = (Date.now() - ts) / 60000;
      if(ageMin > DRAFT_TTL_MIN) return null;
      return parsed;
    }catch{ return null; }
  }
  function writeDraft(data){
    try{
      data.__ts = Date.now();
      sessionStorage.setItem(DRAFT_KEY, JSON.stringify(data));
    }catch(_){}
  }
  function clearDraft(){
    try{ sessionStorage.removeItem(DRAFT_KEY); }catch(_){}
  }

  document.addEventListener('DOMContentLoaded', async ()=>{
    document.querySelectorAll('#ingredient-rows tr').forEach(wireRow);
    if(document.querySelectorAll('#ingredient-rows tr').length === 0) addRow();

    (async function restoreDraft(){
      const url = new URL(location.href);
      const createdId = url.searchParams.get('createdIngredient');
      const allowOnce = sessionStorage.getItem('recipe:allowRestoreOnce') === '1';
      const draft = readDraft();
      const freshEnough = draft ? ((Date.now() - draft.__ts) <= 5*60000) : false;
      const shouldRestore = !!draft && (createdId || allowOnce || freshEnough);
      if(!shouldRestore) return;

      const form = document.querySelector('form.card');
      if(!form) return;

      const setVal = (sel, v)=>{ const el=form.querySelector(sel); if(el!=null && v!=null){ el.value=v; } };
      setVal('[name="title"]', draft.title);
      const diffEl = form.querySelector('#difficulty'); if(diffEl && draft.difficulty!=null) diffEl.value = draft.difficulty;
      setVal('[name="preparationTimeMinutes"]', draft.prep);
      setVal('[name="servings"]', draft.servings);

      const hidden = document.getElementById('mealCategoriesHidden');
      if (hidden && Array.isArray(draft.categories)) {
        const set = new Set(draft.categories.map(String));
        Array.from(hidden.options).forEach(opt => opt.selected = set.has(String(opt.value)));
        syncCheckboxesFromHidden();
      }

      const instrEl = form.querySelector('[name="instructions"]'); if(instrEl && draft.instructions!=null) instrEl.value = draft.instructions;

      const want = Array.isArray(draft.ingredients) ? draft.ingredients.length : 0;
      while (document.querySelectorAll('#ingredient-rows tr').length < want) addRow();

      const rows = Array.from(document.querySelectorAll('#ingredient-rows tr'));
      for (let i=0; i<want; i++){
        const tr = rows[i], rec = draft.ingredients[i] || {};
        const nameInput = tr.querySelector('.ingredient-search');
        const idHidden  = tr.querySelector('input[type="hidden"][name$=".ingredient.id"]');
        const amount    = tr.querySelector('input[name$=".amount"]');
        const unitSel   = tr.querySelector('select[name$=".unit.id"]');

        if (nameInput && rec.text!=null) nameInput.value = rec.text;
        if (idHidden  && rec.id!=null)   idHidden.value  = rec.id;
        if (amount    && rec.amount!=null) amount.value = rec.amount;
        if (unitSel) {
          if (rec.id) {
            try { await loadUnits(unitSel, rec.id, rec.unitId || ''); }
            catch(e){ console.warn('restore units failed:', e); }
          } else if (rec.unitId!=null) {
            unitSel.value = rec.unitId;
          }
        }
      }

      try{ sessionStorage.removeItem('recipe:allowRestoreOnce'); }catch(_){}
    })();

    (async function applyCreated(){
      const params = new URLSearchParams(location.search);
      const createdId = params.get('createdIngredient');
      if(!createdId) return;

      let target = null;
      const lastQuery = sessionStorage.getItem('recipe:lastIngredientQuery');
      if (lastQuery) {
        target = Array.from(document.querySelectorAll('#ingredient-rows tr')).find(tr=>{
          const v = tr.querySelector('.ingredient-search')?.value || '';
          return v.trim().toLowerCase() === lastQuery.trim().toLowerCase();
        });
      }
      if (!target) {
        target = Array.from(document.querySelectorAll('#ingredient-rows tr')).find(tr=>{
          const hid = tr.querySelector('input[type="hidden"][name$=".ingredient.id"]');
          return hid && !hid.value;
        }) || null;
      }
      if (!target) {
        addRow();
        target = document.querySelector('#ingredient-rows tr:last-child');
      }

      const hid = target.querySelector('input[type="hidden"][name$=".ingredient.id"]');
      const unitSel = target.querySelector('.unit-select');
      if (hid) hid.value = createdId;
      if (unitSel) {
        try { await loadUnits(unitSel, createdId, null); } catch(e){ console.warn('units after create:', e); }
      }
      try{ sessionStorage.removeItem('recipe:lastIngredientQuery'); }catch(_){}
    })();


    document.getElementById('clearDraftBtn')?.addEventListener('click', ()=>{

      clearDraft();
      try{
        sessionStorage.removeItem('recipe:lastIngredientQuery');
        sessionStorage.removeItem('recipe:allowRestoreOnce');
      }catch(_){}

      const form = document.querySelector('form.card');
      const hidden = document.getElementById('mealCategoriesHidden');

      const titleEl = form.querySelector('[name="title"]'); if (titleEl) titleEl.value = '';
      const diffEl  = form.querySelector('#difficulty');   if (diffEl)  diffEl.value  = '';
      const prepEl  = form.querySelector('[name="preparationTimeMinutes"]'); if (prepEl) prepEl.value = '';
      const servEl  = form.querySelector('[name="servings"]'); if (servEl) servEl.value = '';
      const instrEl = form.querySelector('[name="instructions"]'); if (instrEl) instrEl.value = '';


      if (hidden) Array.from(hidden.options).forEach(o=>o.selected=false);
      document.querySelectorAll('#catList input[type="checkbox"]').forEach(cb=>cb.checked=false);
      updateCatLabel();


      const tbody = document.getElementById('ingredient-rows');
      if (tbody) {
        tbody.innerHTML = '';
        addRow();
      }

      __suppressNextSave = true;
      setTimeout(()=>{ __suppressNextSave = false; }, 800);

      const url = new URL(location.href);
      if (url.searchParams.has('createdIngredient')) {
        url.searchParams.delete('createdIngredient');
        history.replaceState(null, '', url.toString());
      }

      const btn = document.getElementById('clearDraftBtn');
      const orig = btn.textContent;
      btn.disabled = true;
      btn.textContent = 'Draft cleared';
      setTimeout(()=>{ btn.textContent = orig; btn.disabled = false; }, 1200);
    });
  });

  (function autosave(){
    const form = document.querySelector('form.card');
    if(!form) return;

    function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }

    function snapshot(){
      if (__suppressNextSave) return;
      const hidden = document.getElementById('mealCategoriesHidden');
      const data = {
        __ts: Date.now(),
        title: form.querySelector('[name="title"]')?.value ?? '',
        difficulty: form.querySelector('#difficulty')?.value ?? '',
        prep: form.querySelector('[name="preparationTimeMinutes"]')?.value ?? '',
        servings: form.querySelector('[name="servings"]')?.value ?? '',
        categories: hidden ? Array.from(hidden.selectedOptions).map(o=>o.value) : [],
        instructions: form.querySelector('[name="instructions"]')?.value ?? '',
        ingredients: Array.from(document.querySelectorAll('#ingredient-rows tr')).map(tr=>{
          const nameInput = tr.querySelector('.ingredient-search');
          const idHidden  = tr.querySelector('input[type="hidden"][name$=".ingredient.id"]');
          const amount    = tr.querySelector('input[name$=".amount"]');
          const unitSel   = tr.querySelector('select[name$=".unit.id"]');
          return {
            text: nameInput?.value ?? '',
            id: idHidden?.value ?? '',
            amount: amount?.value ?? '',
            unitId: unitSel?.value ?? ''
          };
        })
      };
      writeDraft(data);
    }

    const saveNow = debounce(snapshot, 200);
    form.addEventListener('input', saveNow);
    window.addEventListener('beforeunload', snapshot);

    form.addEventListener('submit', ()=>{
      try{ sessionStorage.removeItem('recipe:lastIngredientQuery'); }catch(_){}
    });

    document.addEventListener('click', (e)=>{
      const a = e.target.closest('a[href]');
      if(!a) return;
      if(a.href.includes('/ingredients/new-ai')) return;
      try{ sessionStorage.removeItem('recipe:allowRestoreOnce'); }catch(_){}
    });
  })();
</script>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
