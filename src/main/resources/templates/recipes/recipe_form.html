<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <title th:text="${recipe.id == null ? 'Add Recipe' : 'Edit Recipe'}">Recipe</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    :root{
      --accent:#0d6efd;
      --muted:#6c757d;
      --soft-bg:#f8f9fa;
      --card-bg:#ffffff;
      --ring:rgba(13,110,253,.25);
      --table-head:#f2f4f7;
    }
    body.bg-light{background:linear-gradient(180deg,#f7f9fc 0%,#f1f3f5 100%);}
    .card{border-radius:.75rem;border:1px solid #e5e7eb;background:var(--card-bg);}
    .form-label{font-weight:500;color:#212529;}
    .form-control,.form-select{border-radius:.5rem;transition:border .2s,box-shadow .2s;}
    .form-control:focus,.form-select:focus{border-color:var(--accent);box-shadow:0 0 0 .25rem var(--ring);}
    .btn{border-radius:.5rem;padding:.5rem 1rem;font-weight:500;}
    .btn-primary{background:var(--accent);border-color:var(--accent);}
    .btn-outline-danger{border-radius:.375rem;}
    .table thead{background:var(--table-head);}
    .table th{font-weight:600;color:#495057;}
    textarea.form-control{resize:vertical;}
    #ta-results-global{position:fixed;z-index:5000;display:none;max-height:240px;overflow:auto;background:#fff;border:1px solid rgba(0,0,0,.175);border-radius:.375rem;box-shadow:0 8px 24px rgba(0,0,0,.12);}
    #ta-results-global .list-group-item{padding:.5rem .75rem;cursor:pointer;}
    #ta-results-global .list-group-item:hover{background-color:var(--soft-bg);}
  </style>
</head>
<body class="bg-light">
<div class="container py-4">
  <h2 class="mb-4" th:text="${recipe.id == null ? 'Add Recipe' : 'Edit Recipe'}"></h2>

  <form th:object="${recipe}"
        th:action="${recipe.id == null} ? @{/recipes/create} : @{/recipes/update/{id}(id=${recipe.id})}"
        method="post" enctype="multipart/form-data"
        class="card shadow-sm p-4">

    <input type="hidden" name="redirectUrl" th:value="${redirectUrl}" />

    <div class="row g-3">
      <div class="col-md-8">
        <label class="form-label">Title</label>
        <input th:field="*{title}" class="form-control" placeholder="e.g., Creamy Tomato Pasta" />
        <div class="text-danger" th:if="${#fields.hasErrors('title')}" th:errors="*{title}"></div>
      </div>

      <div class="col-md-4">
        <label for="difficulty" class="form-label">Difficulty</label>
        <select id="difficulty" th:field="*{difficulty}" class="form-select" required>
          <option value="" th:if="${recipe.id == null}" selected>Select Difficulty</option>
          <option th:each="difficulty : ${difficulties}"
                  th:value="${difficulty}"
                  th:text="${#strings.toLowerCase(difficulty.name())}"
                  th:selected="${recipe.difficulty != null && difficulty.name() == recipe.difficulty.name()}">
          </option>
        </select>
        <div class="text-danger" th:if="${#fields.hasErrors('difficulty')}" th:errors="*{difficulty}"></div>
      </div>

      <div class="col-md-4">
        <label class="form-label">Preparation Time (minutes)</label>
        <input type="number" th:field="*{preparationTimeMinutes}" class="form-control" min="1">
        <div class="text-danger" th:if="${#fields.hasErrors('preparationTimeMinutes')}" th:errors="*{preparationTimeMinutes}"></div>
      </div>

      <div class="col-md-4">
        <label class="form-label">Servings</label>
        <input type="number" min="0.01" step="0.01" th:field="*{servings}" class="form-control" />
      </div>

      <div class="col-md-4">
        <label class="form-label">Meal Categories</label>
        <select th:field="*{mealCategories}" class="form-select" multiple size="4">
          <option th:each="category : ${categories}"
                  th:value="${category.id}"
                  th:text="${category.name}"
                  th:selected="${recipe.mealCategories != null
                     and #lists.contains(recipe.mealCategories.![id], category.id)}">
          </option>
        </select>
      </div>

      <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
          <label class="form-label mb-0">Ingredients</label>
          <div class="d-flex gap-2">
            <button type="button" class="btn btn-sm btn-secondary" onclick="addRow()">Add row</button>
            <a th:href="@{/ingredients/new}" class="btn btn-sm btn-outline-primary">Add Ingredient to DB</a>
          </div>
        </div>

        <div class="table-responsive mt-2">
          <table class="table align-middle mb-0">
            <thead>
            <tr>
              <th style="width:45%">Ingredient</th>
              <th style="width:20%">Amount</th>
              <th style="width:25%">Unit</th>
              <th style="width:10%">Remove</th>
            </tr>
            </thead>
            <tbody id="ingredient-rows">
            <tr th:each="ri, iStat : *{ingredients}">
              <input type="hidden" th:field="*{ingredients[__${iStat.index}__].id}" />
              <td>
                <input type="hidden" th:field="*{ingredients[__${iStat.index}__].ingredient.id}">
                <input class="form-control ingredient-search"
                       th:value="${ri.ingredient != null ? ri.ingredient.name : ''}"
                       th:attr="data-initial-ingredient=${ri.ingredient != null ? ri.ingredient.id : ''}"
                       placeholder="Type to search…" autocomplete="off" autocapitalize="off" spellcheck="false">
              </td>
              <td>
                <input type="number" min="0.001" step="0.001" class="form-control"
                       th:field="*{ingredients[__${iStat.index}__].amount}">
              </td>
              <td>
                <select class="form-select unit-select"
                        th:field="*{ingredients[__${iStat.index}__].unit.id}"
                        th:attr="data-initial-unit=${ri.unit != null ? ri.unit.id : ''}">
                  <option value="">— none —</option>
                </select>
              </td>
              <td class="text-center">
                <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeRow(this)">✕</button>
              </td>
            </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="col-12">
        <label class="form-label">Instructions</label>
        <textarea th:field="*{instructions}" class="form-control" rows="6"
                  placeholder="Step 1…&#10;Step 2…"></textarea>
      </div>

      <div class="col-12">
        <label for="image" class="form-label">Upload Image</label>
        <input id="image" type="file" name="imageFile" class="form-control">
      </div>

      <div class="col-12 d-flex gap-2 mt-2">
        <button class="btn btn-primary" type="submit" th:text="${recipe.id == null ? 'Create' : 'Update'}"></button>
        <a th:href="${redirectUrl}" class="btn btn-secondary">Cancel</a>
      </div>
    </div>
  </form>
</div>

<div id="ta-results-global" class="list-group"></div>

<script th:inline="javascript">
  const API_ING = /*[[@{/api/ingredients}]]*/ '/api/ingredients';
  const API_UNITS_BASE = /*[[@{/api/ingredients/0/units}]]*/ '/api/ingredients/0/units';
  function unitsUrlFor(ingId){ return API_UNITS_BASE.replace('/0/','/'+ingId+'/'); }

  function nextIndex(){ return document.querySelectorAll('#ingredient-rows tr').length; }
  async function fetchJson(url){
    const r = await fetch(url, { headers: { 'Accept':'application/json' }});
    if(!r.ok) throw new Error(r.status+' '+r.statusText);
    return r.json();
  }
  async function loadUnits(selectEl, ingredientId, initialUnitId){
    selectEl.innerHTML = '<option value="">— none —</option>';
    if(!ingredientId) return;
    try{
      const units = await fetchJson(unitsUrlFor(ingredientId));
      units.forEach(u=>{
        const opt=document.createElement('option');
        opt.value = u.id; opt.textContent = u.label; selectEl.appendChild(opt);
      });
      if(initialUnitId){
        selectEl.value = String(initialUnitId);
        if(selectEl.value !== String(initialUnitId)) selectEl.value = '';
      }
    }catch(e){ console.error('Units fetch failed:', e); }
  }

  const panel = document.getElementById('ta-results-global');
  let activeInput=null, activeHidden=null, activeUnitSelect=null, debounceTimer=null, abortCtrl=null;

  function openPanelFor(input){
    const rect = input.getBoundingClientRect();
    panel.style.left = rect.left + 'px';
    panel.style.top  = (rect.bottom + window.scrollY) + 'px';
    panel.style.width= rect.width + 'px';
    panel.style.display = 'block';
  }
  function closePanel(){ panel.style.display='none'; panel.innerHTML=''; }

  async function searchIngredients(q){
    if(q.length < 1){ closePanel(); return; }
    if(abortCtrl) abortCtrl.abort();
    abortCtrl = new AbortController();
    try{
      const r = await fetch(`${API_ING}?q=${encodeURIComponent(q)}&size=50`, { signal: abortCtrl.signal });
      if(!r.ok){ console.error('Ingredient search failed:', r.status, r.statusText); closePanel(); return; }
      const page = await r.json();
      const list = page && page.content ? page.content : [];
      panel.innerHTML = '';
      if(list.length === 0){
        const empty = document.createElement('div');
        empty.className='list-group-item text-muted'; empty.textContent='No results';
        panel.appendChild(empty);
      }else{
        list.forEach(it=>{
          const btn=document.createElement('button');
          btn.type='button'; btn.className='list-group-item list-group-item-action'; btn.textContent=it.name;
          btn.addEventListener('pointerdown', async (e)=>{
            e.preventDefault();
            if(!activeInput || !activeHidden) return;
            activeHidden.value = it.id;
            activeInput.value  = it.name;
            closePanel();
            if(activeUnitSelect) await loadUnits(activeUnitSelect, it.id, null);
            activeInput.focus();
          });
          panel.appendChild(btn);
        });
      }
      if(activeInput) openPanelFor(activeInput);
    }catch(e){
      if(e.name !== 'AbortError') console.error('Ingredient search error:', e);
      closePanel();
    }
  }

  function wireRow(tr){
    const input    = tr.querySelector('.ingredient-search');
    const hiddenId = tr.querySelector('input[type="hidden"][name$=".ingredient.id"]');
    const unitSel  = tr.querySelector('.unit-select');

    const initIng  = input.getAttribute('data-initial-ingredient') || '';
    const initUnit = unitSel.getAttribute('data-initial-unit') || '';
    if(initIng) loadUnits(unitSel, initIng, initUnit);

    input.addEventListener('focus', ()=>{
      activeInput=input; activeHidden=hiddenId; activeUnitSelect=unitSel;
      if(input.value.trim().length >= 1){
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(()=>searchIngredients(input.value.trim()), 120);
      }
    });
    input.addEventListener('input', ()=>{
      activeInput=input; activeHidden=hiddenId; activeUnitSelect=unitSel;
      clearTimeout(debounceTimer);
      const q = input.value.trim();
      debounceTimer = setTimeout(()=>searchIngredients(q), 120);
    });
  }

  function addRow(){
    const i = nextIndex();
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <input type="hidden" name="ingredients[${i}].id" value="">
      <td>
        <input type="hidden" name="ingredients[${i}].ingredient.id" value="">
        <input class="form-control ingredient-search" placeholder="Type to search…" autocomplete="off" autocapitalize="off" spellcheck="false" data-initial-ingredient="">
      </td>
      <td>
        <input type="number" min="0.001" step="0.001" class="form-control"
               name="ingredients[${i}].amount" placeholder="e.g., 2.5">
      </td>
      <td>
        <select class="form-select unit-select" name="ingredients[${i}].unit.id" data-initial-unit="">
          <option value="">— none —</option>
        </select>
      </td>
      <td class="text-center">
        <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeRow(this)">✕</button>
      </td>
    `;
    document.getElementById('ingredient-rows').appendChild(tr);
    wireRow(tr);
  }

  function removeRow(btn){
    const tr = btn.closest('tr'); if(tr) tr.remove();
    document.querySelectorAll('#ingredient-rows tr').forEach((row, idx)=>{
      row.querySelectorAll('select, input').forEach(el=>{
        el.name = el.name.replace(/ingredients\[\d+]/, 'ingredients['+idx+']');
      });
    });
    closePanel();
  }

  document.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter' && document.activeElement && document.activeElement.classList.contains('ingredient-search')){
      e.preventDefault();
    }
  });

  document.addEventListener('click', (e)=>{ if(panel.style.display==='block' && !panel.contains(e.target) && e.target !== activeInput) closePanel(); });
  window.addEventListener('scroll', ()=>{ if(panel.style.display==='block' && activeInput) openPanelFor(activeInput); }, true);
  window.addEventListener('resize', ()=>{ if(panel.style.display==='block' && activeInput) openPanelFor(activeInput); });

  document.addEventListener('DOMContentLoaded', ()=>{
    document.querySelectorAll('#ingredient-rows tr').forEach(wireRow);
    if(document.querySelectorAll('#ingredient-rows tr').length === 0) addRow();
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
