<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <title th:text="${recipe.id == null} ? 'Add Recipe' : 'Edit Recipe'">Recipe</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body class="bg-light">
<div class="container py-4">
  <h2 class="mb-4" th:text="${recipe.id == null} ? 'Add Recipe' : 'Edit Recipe'"></h2>

  <form th:object="${recipe}"
        th:action="${recipe.id == null} ? @{/recipes/create} : @{/recipes/update/{id}(id=${recipe.id})}"
        method="post" enctype="multipart/form-data"
        class="card shadow-sm p-4">

    <input type="hidden" name="redirectUrl" th:value="${redirectUrl}" />

    <div class="row g-3">

      <div class="col-md-8">
        <label class="form-label">Title</label>
        <input th:field="*{title}" class="form-control" placeholder="e.g., Creamy Tomato Pasta" />
        <div class="text-danger" th:if="${#fields.hasErrors('title')}" th:errors="*{title}"></div>
      </div>

      <div class="col-md-4">
        <label class="form-label">Difficulty</label>
        <select th:field="*{difficulty}" class="form-select" required>
          <option value="">Select…</option>
          <option th:each="d : ${difficulties}" th:value="${d}" th:text="${d}"></option>
        </select>
        <div class="text-danger" th:if="${#fields.hasErrors('difficulty')}" th:errors="*{difficulty}"></div>
      </div>

      <div class="col-md-4">
        <label class="form-label">Prep Time (min)</label>
        <input type="number" min="1" th:field="*{preparationTimeMinutes}" class="form-control" />
        <div class="text-danger" th:if="${#fields.hasErrors('preparationTimeMinutes')}" th:errors="*{preparationTimeMinutes}"></div>
      </div>

      <div class="col-md-4">
        <label class="form-label">Servings</label>
        <input type="number" min="0.01" step="0.01" th:field="*{servings}" class="form-control" />
        <div class="text-danger" th:if="${#fields.hasErrors('servings')}" th:errors="*{servings}"></div>
      </div>

      <div class="col-md-4">
        <label class="form-label">Meal Categories</label>
        <select th:field="*{mealCategories}" class="form-select" multiple size="4">
          <option th:each="category : ${categories}"
                  th:value="${category.id}"
                  th:text="${category.name}"></option>"
        </select>
      </div>

      <div class="mb-3">
        <div class="d-flex justify-content-between align-items-center">
          <label class="form-label mb-0">Ingredients</label>
          <div class="d-flex gap-2">
            <button type="button" class="btn btn-sm btn-secondary" id="addRowBtn">Add Row</button>
            <button type="button" class="btn btn-sm btn-outline-primary" onclick="openNewIngredientModal()">New Ingredient</button>
          </div>
        </div>

        <div id="ingredient-rows" class="mt-2">
          <div class="row g-2 mb-2 align-items-end" th:each="ingredient, iterStat: *{ingredients}">
            <input type="hidden" th:field="*{ingredients[__${iterStat.index}__].id}" />

            <div class="col-lg-6">
              <label class="form-label">Ingredient</label>
              <select class="form-select ingredient-select"
                      th:field="*{ingredients[__${iterStat.index}__].ingredient.id}"
                      onchange="onIngredientChange(this)">
                <option value="">Ingredient…</option>

                <option th:each="ing : ${recipe.ingredients}"
                        th:value="${ing.id}"
                        th:text="${ing.ingredient.name}">
                </option>

                <optgroup label="New in this form" class="dynamic-new-ing"></optgroup>
              </select>
            </div>

            <div class="col-lg-3">
              <label class="form-label">Amount</label>
              <input type="number" min="0.001" step="0.001"
                     class="form-control"
                     th:field="*{ingredients[__${iterStat.index}__].amount}" placeholder="e.g. 2.5">
            </div>

            <div class="col-lg-2">
              <label class="form-label">Unit</label>
              <select class="form-select"
                      th:field="*{ingredients[__${iterStat.index}__].unit.id}">
                <option value="">Unit…</option>
                <option th:each="u : ${unitList}"
                        th:value="${u.id}"
                        th:text="${u.displayName != null ? u.displayName : u.code}">
                </option>
              </select>
            </div>

            <div class="col-lg-1 d-grid">
              <button type="button" class="btn btn-outline-danger" onclick="removeRow(this)">✕</button>
            </div>
          </div>
        </div>

        <div class="text-danger" th:if="${#fields.hasErrors('ingredients')}" th:errors="*{ingredients}"></div>
      </div>

      <div id="new-ingredients-hidden"></div>

      <div class="modal fade" id="newIngredientModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Create New Ingredient</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
              <div class="mb-3">
                <label class="form-label">Name</label>
                <input id="newIngName" class="form-control" placeholder="e.g., Zucchini">
              </div>

              <div class="mb-3">
                <label class="form-label">Category (optional)</label>
                <select id="newIngCategoryId" class="form-select">
                  <option value="">— none —</option>
                  <option th:each="cat : ${ingredientCategories}"
                          th:value="${cat.id}"
                          th:text="${cat.name}"></option>
                </select>
              </div>

              <hr class="my-3">

              <div class="row g-2">
                <div class="col-6">
                  <label class="form-label">Amount (for this recipe)</label>
                  <input id="newIngAmount" type="number" min="0.001" step="0.001" class="form-control" placeholder="e.g., 2.5">
                </div>
                <div class="col-6">
                  <label class="form-label">Unit</label>
                  <select id="newIngUnitId" class="form-select">
                    <option value="">Unit…</option>
                    <option th:each="u : ${unitList}"
                            th:value="${u.id}"
                            th:text="${u.displayName != null ? u.displayName : u.code}"></option>
                  </select>
                </div>
              </div>
            </div>

            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="button" class="btn btn-primary" onclick="saveNewIngredient()">Add</button>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12">
        <label class="form-label">Instructions</label>
        <textarea th:field="*{instructions}" class="form-control" rows="6"
                  placeholder="Step 1…&#10;Step 2…"></textarea>
      </div>

      <div class="col-12">
        <label for="image" class="form-label">Upload Image</label>
        <input id="image" type="file" name="imageFile" class="form-control">
      </div>

      <div class="col-12 d-flex gap-2 mt-2">
        <button class="btn btn-primary" type="submit" th:text="${recipe.id == null} ? 'Create' : 'Update'"></button>
        <a th:href="${redirectUrl}" class="btn btn-secondary">Cancel</a>
      </div>
    </div>
  </form>
</div>

<script th:inline="javascript">
  /*<![CDATA[*/

  const ingredientsLookup = /*[[${ingredientsList}]]*/ [];
  const unitsLookup = /*[[${unitsList}]]*/ [];
  const ingCats = /*[[${ingredientCategories}]]*/ [];

  let nextTempIngredientId = -1;

  document.getElementById('addRowBtn').addEventListener('click', addIngredientRow);

  function addIngredientRow(prefill = null) {
    const container = document.getElementById('ingredient-rows');
    const index = container.querySelectorAll('.row.g-2').length;

    const row = document.createElement('div');
    row.className = 'row g-2 mb-2 align-items-end';

    const ingOptions = [
      '<option value="">Ingredient…</option>',
      ...ingredientsLookup.map(i => `<option value="${i.id}">${escapeHtml(i.name)}</option>`),
      '<optgroup label="New in this form" class="dynamic-new-ing"></optgroup>'
    ].join('');

    const unitOptions = [
      '<option value="">Unit…</option>',
      ...unitsLookup.map(u => `<option value="${u.id}">${escapeHtml(u.displayName ?? u.code)}</option>`)
    ].join('');

    row.innerHTML = `
      <input type="hidden" name="ingredients[${index}].id">
      <div class="col-lg-6">
        <label class="form-label">Ingredient</label>
        <select class="form-select ingredient-select" name="ingredients[${index}].ingredientId" onchange="onIngredientChange(this)">
          ${ingOptions}
        </select>
      </div>
      <div class="col-lg-3">
        <label class="form-label">Amount</label>
        <input type="number" min="0.001" step="0.001" class="form-control" name="ingredients[${index}].amount" placeholder="e.g. 2.5">
      </div>
      <div class="col-lg-2">
        <label class="form-label">Unit</label>
        <select class="form-select" name="ingredients[${index}].unitId">
          ${unitOptions}
        </select>
      </div>
      <div class="col-lg-1 d-grid">
        <button type="button" class="btn btn-outline-danger" onclick="removeRow(this)">✕</button>
      </div>
    `;

    container.appendChild(row);

    // Prefill from modal (ingredient + amount + unit)
    if (prefill?.ingredientId != null) {
      row.querySelector('.ingredient-select').value = String(prefill.ingredientId);
    }
    if (prefill?.amount != null && !Number.isNaN(prefill.amount)) {
      row.querySelector(`input[name="ingredients[${index}].amount"]`).value = prefill.amount;
    }
    if (prefill?.unitId) {
      row.querySelector(`select[name="ingredients[${index}].unitId"]`).value = String(prefill.unitId);
    }
  }

  function removeRow(btn) {
    const row = btn.closest('.row.g-2');
    row?.parentNode?.removeChild(row);
  }

  function onIngredientChange(selectEl) {
    // hook for future behavior if needed
  }

  // === New Ingredient Modal helpers ===
  let newIngModal;
  function openNewIngredientModal() {
    const modalEl = document.getElementById('newIngredientModal');
    newIngModal = bootstrap.Modal.getOrCreateInstance(modalEl);
    document.getElementById('newIngName').value = '';
    document.getElementById('newIngCategoryId').value = '';
    document.getElementById('newIngAmount').value = '';
    document.getElementById('newIngUnitId').value = '';
    newIngModal.show();
  }

  function saveNewIngredient() {
    const name = document.getElementById('newIngName').value?.trim();
    if (!name) {
      alert('Please enter a name for the ingredient.');
      return;
    }
    const categoryId = document.getElementById('newIngCategoryId').value || '';
    const amountRaw = document.getElementById('newIngAmount').value;
    const unitId = document.getElementById('newIngUnitId').value || '';

    const amount = amountRaw !== '' ? Number(amountRaw) : null;
    if (amountRaw !== '' && (isNaN(amount) || amount <= 0)) {
      alert('Please provide a valid amount greater than 0.');
      return;
    }

    // assign a temporary negative ID so it doesn't collide with real DB IDs
    const tempId = nextTempIngredientId--;

    // 1) hidden inputs for backend to create this ingredient
    const hiddenBucket = document.getElementById('new-ingredients-hidden');
    const newIndex = hiddenBucket.querySelectorAll('[data-new-ing="1"]').length;

    const wrapper = document.createElement('div');
    wrapper.dataset.newIng = '1';
    wrapper.innerHTML = `
      <input type="hidden" name="newIngredients[${newIndex}].tempId" value="${tempId}">
      <input type="hidden" name="newIngredients[${newIndex}].name" value="${escapeAttr(name)}">
      <input type="hidden" name="newIngredients[${newIndex}].categoryId" value="${escapeAttr(categoryId)}">
    `;
    hiddenBucket.appendChild(wrapper);

    // 2) add this new ingredient to every dropdown under an <optgroup>
    const allSelects = document.querySelectorAll('#ingredient-rows .ingredient-select');
    allSelects.forEach(sel => {
      let group = sel.querySelector('optgroup.dynamic-new-ing');
      if (!group) {
        const og = document.createElement('optgroup');
        og.label = 'New in this form';
        og.classList.add('dynamic-new-ing');
        sel.appendChild(og);
        group = og;
      }
      const opt = document.createElement('option');
      opt.value = String(tempId);
      opt.textContent = name;
      group.appendChild(opt);
    });

    // 3) add a new row pre-selected with this ingredient, amount, and unit
    addIngredientRow({ ingredientId: tempId, amount, unitId: unitId || null });

    newIngModal.hide();
  }

  // util helpers
  function escapeHtml(s) {
    return s?.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])) ?? '';
  }
  function escapeAttr(s) {
    return String(s ?? '').replace(/"/g, '&quot;');
  }
  /*]]>*/
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
