<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Admin • Meal Plans</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/css/navigation_tab_styles.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background:#f6f8fb; }
        .wrap { max-width:1100px; }
        .truncate { max-width:360px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    </style>
</head>
<body>
<div th:replace="~{/fragments/navigation_tab :: navigation}"></div>

<main class="container wrap py-4">
    <div class="d-flex align-items-center justify-content-between">
        <a th:href="${backUrl}" class="btn btn-link px-0 text-decoration-none">&larr; Back</a>
    </div>

    <h1 class="h4 fw-bold mt-2">Manage Meal Plans</h1>

    <div th:if="${success}" class="alert alert-success alert-dismissible fade show mt-2" role="alert">
        <span th:text="${success}">Success</span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    <div th:if="${error}" class="alert alert-danger alert-dismissible fade show mt-2" role="alert">
        <span th:text="${error}">Something went wrong</span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>

    <div class="row g-3 align-items-end mt-1">
        <div class="col-12 col-md-6">
            <div class="text-muted">
                Total meal plans: <span class="fw-semibold" th:text="${totalMealPlans}">0</span>
            </div>
        </div>

        <div class="col-12 col-md-6">
            <label class="form-label mb-1">Search (owner email or plan name)</label>
            <form th:action="@{/admin/meal-plans}" method="get" class="d-flex">
                <input type="hidden" name="page" value="0">
                <input type="hidden" name="size" th:value="${page.size}">
                <input name="q" class="form-control me-2" placeholder="type to search..." th:value="${q}">
                <button class="btn btn-outline-primary">Go</button>
            </form>
        </div>
    </div>

    <!-- table -->
    <div class="table-responsive mt-3">
        <table class="table align-middle">
            <thead>
            <tr>
                <th>ID</th>
                <th>Plan Name</th>
                <th>Owner Email</th>
                <th>Week</th>
                <th>Kcal/Day</th>
                <th>Created</th>
                <th class="text-end">Actions</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="p : ${page.content}">
                <td th:text="${p.id}">1</td>
                <td class="truncate" th:text="${p.name}">Plan name</td>
                <td class="truncate" th:text="${p.user != null ? p.user.email : '—'}">email@example.com</td>
                <td>
                    <span th:text="${#temporals.format(p.startDate, 'yyyy-MM-dd')}">2025-09-15</span>
                    —
                    <span th:text="${#temporals.format(p.endDate, 'yyyy-MM-dd')}">2025-09-21</span>
                </td>
                <td th:text="${p.kcalTargetPerDay != null ? p.kcalTargetPerDay : '—'}">—</td>
                <td><small class="text-muted" th:text="${#temporals.format(p.createdAt, 'yyyy-MM-dd HH:mm')}">—</small></td>
                <td class="text-end">
                    <a th:href="@{'/admin/meal-plans/' + ${p.id}}" class="btn btn-sm btn-outline-primary">View</a>

                    <form th:action="@{'/admin/meal-plans/' + ${p.id} + '/delete'}"
                          method="post" class="d-inline"
                          th:attr="onsubmit=|return confirm('Delete meal plan #' + '${p.id}' + ' permanently?')|">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                        <button class="btn btn-sm btn-outline-danger">Delete</button>
                    </form>
                </td>
            </tr>

            <tr th:if="${page.content.isEmpty()}">
                <td colspan="7" class="text-center text-muted">No meal plans found.</td>
            </tr>
            </tbody>
        </table>
    </div>

    <nav th:if="${page.totalPages > 1}" class="mt-2">
        <ul class="pagination">
            <li class="page-item" th:classappend="${page.first} ? 'disabled'">
                <a class="page-link" th:href="@{/admin/meal-plans(q=${q},page=${0},size=${page.size})}">First</a>
            </li>
            <li class="page-item" th:classappend="${page.first} ? 'disabled'">
                <a class="page-link" th:href="@{/admin/meal-plans(q=${q},page=${page.number-1},size=${page.size})}">Prev</a>
            </li>
            <li class="page-item disabled">
                <span class="page-link" th:text="${page.number + 1} + ' / ' + ${page.totalPages}">1 / 1</span>
            </li>
            <li class="page-item" th:classappend="${page.last} ? 'disabled'">
                <a class="page-link" th:href="@{/admin/meal-plans(q=${q},page=${page.number+1},size=${page.size})}">Next</a>
            </li>
            <li class="page-item" th:classappend="${page.last} ? 'disabled'">
                <a class="page-link" th:href="@{/admin/meal-plans(q=${q},page=${page.totalPages-1},size=${page.size})}">Last</a>
            </li>
        </ul>
    </nav>
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
